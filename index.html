<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>cybercook</title>
    <script src="//unpkg.com/alpinejs" defer></script>
    <script src="//cdn.tailwindcss.com"></script>
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('data',  () => ({
                dragging: false,
                adding: {},
                search: '',
                input: 'place input here',
                output: 'output will appear here',
                modules: [],
                cookbook: [],
                init() {
                    fetch('modules.json')
                    .then(response => {
                        if (!response.ok) alert(`Something went wrong: ${response.status} - ${response.statusText}`)
                        return response.text()
                    })
                    .then(data => {
                        this.modules = JSON.parse(data);
                    })
                },
                loadModule: function (mod, loaded) {
                    if (mod.loaded === true) {
                        loaded();
                        return;
                    }
                    fetch(mod.path)
                        .then(response => {
                            if (!response.ok) alert(`Something went wrong: ${response.status} - ${response.statusText}`)
                            return response.text()
                        })
                        .then(data => {
                            const result = eval(data);
                            for (let i = 0; i < this.modules.length; i++) {
                                if (this.modules[i].name === result.name) {
                                    this.modules[i] = {...this.modules[i], ...result};
                                    this.modules[i].loaded = true;
                                    if (result.onload !== undefined) {
                                        result.onload(loaded);
                                        return;
                                    }
                                    loaded();
                                    return;
                                }
                            }
                        })
                },

                deleteModule(mod) {
                    const id = mod.id;
                    for (let j = 0; j < this.cookbook.length; j++) {
                        if (this.cookbook[j].id === id) {
                            this.cookbook.splice(j, 1);
                            return;
                        }
                    }
                },

                addModuleToCookbook(where, modPath) {
                    const _this = this;
                    for (let i = 0; i < this.modules.length; i++) {
                        if (this.modules[i].path === modPath) {
                            this.loadModule(this.modules[i], function () {
                                let mod = {
                                    id: Date.now().toString(),
                                    name: _this.modules[i].name,
                                    description: _this.modules[i].description,
                                    path: _this.modules[i].path,
                                    properties: [],
                                    enabled: true,
                                    run: _this.modules[i].run,
                                }

                                for (let j = 0; j < _this.modules[i].properties.length; j++) {
                                    mod.properties.push({
                                        name: _this.modules[i].properties[j].name,
                                        type: _this.modules[i].properties[j].type,
                                        value: _this.modules[i].properties[j].default,
                                        enabled: _this.modules[i].properties[j].enabled_on_default ?? true,
                                        optional: _this.modules[i].properties[j].optional ?? false,
                                    });
                                }

                                if (where === 'start') {
                                    if (_this.cookbook.length === 0) {
                                        _this.cookbook.push(mod);
                                        return;
                                    }
                                    _this.cookbook.unshift(mod);
                                    return;
                                }
                                if (where === 'end') {
                                    _this.cookbook.push(mod);
                                    return;
                                }

                                for (let j = 0; j < _this.cookbook.length; j++) {
                                    if (_this.cookbook[j].id === where) {
                                        _this.cookbook.splice(j+1, 0, mod);
                                        return;
                                    }
                                }

                            });
                            return;
                        }
                    }
                },
                buildProps: function (text, properties) {
                    const props = [text];
                    for (let i = 0; i < properties.length; i++) {
                        if (properties[i].optional && !properties[i].enabled) {
                            props.push(undefined);
                            continue
                        }
                        props.push(properties[i].value);
                    }
                    return props;
                },
                runCookbook: function () {
                    let text = this.input;
                    for (let i = 0; i < this.cookbook.length; i++) {
                        if (!this.cookbook[i].enabled) {
                            continue;
                        }
                        try {
                            text = this.cookbook[i].run.apply(this, this.buildProps(text, this.cookbook[i].properties));
                        } catch (e) {
                            this.output = e.message;
                            return;
                        }
                    }
                    this.output = text;
                },
            }));
        });
    </script>
</head>
    <body class="w-screen h-screen bg-zinc-400 box-sizing" x-data="data">
    <main class="flex h-full w-full p-2 space-x-2">
        <div class="resize-x overflow-auto w-[20%] p-2 bg-stone-900 text-white">
            <h1 class="border-b-2 text-2xl cursor-default mb-4">Modules</h1>
            <input type="text" x-model="search" class="bg-stone-500 w-full" placeholder="filter...">
            <template x-for="module in modules">
                <template x-if="search == '' || module.name.toLowerCase().indexOf(search.toLowerCase()) != -1 || module.categories.find(x => x.toLowerCase().indexOf(search.toLowerCase()) != -1)">
                    <div
                        class="cursor-grab"
                        :class="{'cursor-grabbing': dragging}"
                        @dragstart.self="
                            dragging = true;
                            event.dataTransfer.effectAllowed='move';
                            event.dataTransfer.setData('text/plain', module.path);
                            "
                        @dragend="dragging = false"
                        x-text="module.name"
                        :title="module.description"
                        draggable="true"
                    ></div>
                </template>
            </template>
        </div>
        <div class="resize-x overflow-auto w-[40%] p-2 flex flex-col bg-stone-900 text-white">
            <div class="flex flex-row border-b-2 text-2xl cursor-default text-white">
                <div>Cookbook</div>
                <div class="flex flex-row grow justify-end space-x-2">
                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-sm" title="Run" @click="runCookbook()">Run â–¶</button>
                </div>
            </div>

            <div class="flex flex-col flex-auto overflow-scroll">
                <div
                     class="min-h-[1rem] bg-stone-900 flex items-center"
                     :class="{
                        'bg-orange-100': adding['start'] || adding['end'] && cookbook.length == 0,
                        'bg-orange-200': dragging,
                        'flex-auto': cookbook.length == 0,
                     }"
                     @drop="adding['start'] = false"
                     @drop.prevent="addModuleToCookbook('start', event.dataTransfer.getData('text/plain'))"
                     @dragover.prevent="adding['start'] = true"
                     @dragleave.prevent="adding['start'] = false">
                    <template x-if="cookbook.length == 0">
                        <div class="text-center text-xl flex-auto cursor-default">Drag modules here</div>
                    </template>
                </div>
                <template x-for="module in cookbook">
                    <div class="flex flex-col odd:bg-stone-700 even:bg-stone-600">
                        <div class="space-y-2 p-2">
                            <div class="text-lg flex flex-row">
                                <div class="grow" x-text="module.name" :title="module.description"></div>
                                <input type="checkbox" x-model="module.enabled"/>
                                <button @click="deleteModule(module)">Delete</button>
                            </div>
                            <template x-for="property in module.properties">
                                <div>
                                    <template x-if="property.type === 'boolean'">
                                        <div class="flex flex-row space-x-1 items-center" x-data="{ id: $id('value') }">
                                            <input type="checkbox" x-model="property.value" :id="id"/>
                                            <label x-text="property.name" :for="id"></label>
                                        </div>
                                    </template>
                                    <template x-if="property.type === 'text'">
                                        <div class="flex flex-col items-start" x-data="{ id: $id('value') }">
                                            <div class="flex flex-row items-center">
                                                <template x-if="property.optional">
                                                    <input type="checkbox" x-model="property.enabled" class="me-1" :id="id"/>
                                                </template>
                                                <label x-text="property.name" :for="id"></label>
                                            </div>
                                            <textarea class="bg-stone-500 font-mono w-full" x-model="property.value" :disabled="!property.enabled"></textarea>
                                        </div>
                                    </template>
                                    <template x-if="property.type === 'number'">
                                        <div class="flex flex-col items-start" x-data="{ id: $id('value') }">
                                            <div class="flex flex-row items-center">
                                                <template x-if="property.optional">
                                                    <input type="checkbox" x-model="property.enabled" class="me-1" :id="id"/>
                                                </template>
                                                <label x-text="property.name" :for="id"></label>
                                            </div>
                                            <input type="number" class="bg-stone-500 font-mono w-full" x-model.number="property.value" :disabled="!property.enabled"/>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                        <div
                             class="h-4 bg-stone-900"
                             :class="{
                                'bg-orange-100': adding[module.id],
                                'bg-orange-200': dragging,
                            }"
                             @drop="adding[module.id] = false"
                             @drop.prevent="addModuleToCookbook(module.id, event.dataTransfer.getData('text/plain'))"
                             @dragover.prevent="adding[module.id] = true"
                             @dragleave.prevent="adding[module.id] = false"></div>
                    </div>
                </template>
                <div
                    class="flex-auto"
                    :class="{
                            'bg-orange-100': adding['end'] || adding['start'] && cookbook.length == 0,
                            'bg-orange-200': dragging,
                        }"
                    @drop="adding['end'] = false"
                    @drop.prevent="addModuleToCookbook('end', event.dataTransfer.getData('text/plain'))"
                    @dragover.prevent="adding['end'] = true"
                    @dragleave.prevent="adding['end'] = false"></div>
            </div>
            <div class="flex flex-col items-center mt-2">
                <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" @click="runCookbook()">Run â–¶</button>
            </div>
        </div>
        <div class="flex flex-col grow space-y-2">
            <div class="resize-y overflow-auto h-[50%] p-2 bg-stone-900 flex flex-col">
                <h1 class="border-b-2 text-2xl cursor-default mb-4 text-white">Input</h1>
                <textarea class="w-full h-full resize-none bg-stone-900 text-white border-none font-mono" x-model="input"></textarea>
            </div>
            <div class="grow bg-stone-900 p-2 flex flex-col">
                <div class="flex flex-row border-b-2 text-2xl cursor-default mb-4 text-white">
                    <div>Output</div>
                    <div class="flex flex-row grow justify-end space-x-2">
                        <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-sm" title="Copy output to clipboard" @click="navigator.clipboard.writeText(output)">ðŸ“‹</button>
                        <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-sm" title="Replace input with output" @click="input = output">â–²</button>

                    </div>
                </div>
                <textarea class="w-full h-full resize-none bg-stone-900 text-white border-none font-mono" x-model="output"></textarea>
           </div>
       </div>
   </main>
   </body>
</html>
